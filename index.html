<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="utf-8">
  <title>Instagram Private Download</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/cover.css">
</head>

<body class="text-center">
  <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
    <header class="masthead mb-auto">
      <div class="inner">
        <h3 class="masthead-brand">Private Download</h3>
      <!--  <nav class="nav nav-masthead justify-content-center">
          <a class="nav-link active" href="#">Истории</a>
        </nav> -->
      </div>
    </header>

    <main role="main" class="inner cover" id="MainArea">
      <h1 class="cover-heading">Скачивание историй</h1>
      <p class="lead">Перед тем как начать авторизуйтесь в Instagram с браузера. Как только зайдете возварщайтесь на сайт и жмите "Дальше".</p>
      <p class="lead">
        <a href="https://www.instagram.com/accounts/login" target="_blank" class="btn btn-primary col-md-4" id="LoginInst">Авторизация Instagram</a>
        <a href="#" class="btn btn-success disabled col-md-4" aria-disabled="true" id="Continue1">Дальше</a>
      </p>
      <br>
    </main>

    <footer class="mastfoot mt-auto">
      <div class="inner">
        <p>Ningaro. The Lords. 2019(c)</p>
      </div>
    </footer>
  </div>
</body>

<!-- Bootstrap js -->
<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<!-- Custom js -->
<script type="text/javascript">
  $('#LoginInst').on("click", function() {
    $('#Continue1').removeClass('disabled');
    $('#Continue1').attr("aria-disabled", "false");
  });

  $('#Continue1').on("click", function() {

    var hash;

    // Get запрос

    var xhr1 = new XMLHttpRequest();

    xhr1.open("GET", 'https://www.instagram.com/static/bundles/es6/Consumer.js/0d1c70eefeee.js');

    xhr1.onload = function() {
      if (xhr1.readyState === xhr1.DONE) {
        if (xhr1.status === 200) {
          var mytext = xhr1.response;

          console.log(mytext.substring(mytext.indexOf(`h="`) + 3, mytext.indexOf(`"`, mytext.indexOf(`h="`) + 3)));

          hash = mytext.substring(mytext.indexOf(`h="`) + 3, mytext.indexOf(`"`, mytext.indexOf(`h="`) + 3));

          $('#MainArea').html(
            `<div class="input-group mb-2 pl-3 pr-3"><input type="text" class="form-control" placeholder="@nickname" id="nickname"><div class="input-group-append"><button class="btn btn-success" type="button" id="Continue2">Дальше</button></div></div><p class="lead">В поле выше введите никнейм пользователя, чьи истории вы хотите скачать. Затем нажмите кнопку "Дальше".</p><div class=" row justify-content-md-center m-4" id="ans"></div><div class="card-deck" id="cards_ans"></div>`
          );

          $('#Continue2').on("click", function() {

            var nickname = $('#nickname').val();

            if ($('#nickname').val().indexOf('@') == -1) {

              // Get запрос

              var xhr2 = new XMLHttpRequest();

              xhr2.open("GET", `https://www.instagram.com/${nickname}/`);

              xhr2.onload = function() {
                if (xhr2.readyState === xhr2.DONE) {
                  if (xhr2.status === 200) {
                    var mytext = xhr2.response;
                    var userid;
                    mytext = JSON.parse(mytext.substring(mytext.indexOf(`window._sharedData = `) + 21, mytext.indexOf(`;<\/script>`, mytext.indexOf(`window._sharedData = `) + 21)));
                    userid = (mytext.entry_data.ProfilePage[0].graphql.user.id);
                    avatar = mytext.entry_data.ProfilePage[0].graphql.user.profile_pic_url_hd;
                    $('#ans').html(`<div class="card text-white bg-dark mb-3" style="max-width: 18rem;"><div class="card-header"><img src="${avatar}" width="30px"> ${nickname}</div><div class="card-body"><p class="card-text"><a href="https://www.instagram.com/graphql/query/?query_hash=${hash}&amp;variables=%0A%7B%22reel_ids%22%3A%5B%22${userid}%22%5D%2C%22tag_names%22%3A%5B%5D%2C%22location_ids%22%3A%5B%5D%2C%22highlight_reel_ids%22%3A%5B%5D%2C%22precomposed_overlay%22%3Afalse%2C%22show_story_viewer_list%22%3Atrue%2C%22story_viewer_fetch_count%22%3A50%2C%22story_viewer_cursor%22%3A%22%22%2C%22stories_video_dash_manifest%22%3Afalse%7D" target="_blank">https://www.instagram.com/stories...</a></p></div></div><p class="lead">Перейдите по ссылке и скопируйте содержимое страницы. После вставьте его в поле ниже и нажмите "Обработать".</p></div><br><br><p class="lead"><p class="form-group col-md-12"><textarea id="code_rewive" placeholder="Код сюда" rows="3" class="form-control"></textarea></p><p class="col-md-12"><button type="button" id="Continue3" class="btn btn-success">Обработать</button></p></div>` );
                    console.log(userid);
                    console.log(hash);

                    $('#Continue3').on("click", function() {
                      var somecode = JSON.parse($('#code_rewive').val());
                      var cards ='';
                          somecode.data.reels_media[0].items.forEach(function(element) {
                            //Выдача переменных
                            var author_name = element.owner.username;
                            var long_create = Math.round((new Date() - element.taken_at_timestamp * 1000)/1000/3600);
                            if (element.is_video == true) {
                              var type_content = `<span class="badge badge-warning">Video</span>`
                            } else {
                              var type_content = `<span class="badge badge-info">Picture</span>`
                            }
                            var background_img = element.display_resources[2].src;
                            if (type_content == `<span class="badge badge-warning">Video</span>`) {
                              var download_link = element.video_resources[1].src
                            } else {
                              var download_link = background_img
                            }
                            //Присвоение пермеменных в карточках
                            cards = cards +
                              `<div class="card bg-dark text-white"><img src="${background_img}" class="card-img"><div class="card-img-overlay"><h5 class="card-title text-left">${author_name}${type_content}</h5><p class="card-text text-left" style="margin-top: 150%;">${long_create} ч.</p>                            <p class="card-text text-right"><a href="${download_link}" role="button" class="btn btn-success">Скачать</a></p></div></div>`;
                          });

                          $('#cards_ans').html(cards);
                    });



                  }
                }
              };

              xhr2.send();

            } else {

              nickname = nickname.substring(1, nickname.length + 1);

              // Get запрос

              var xhr3 = new XMLHttpRequest();

              xhr3.open("GET", `https://www.instagram.com/${nickname}/`);

              xhr3.onload = function() {
                if (xhr3.readyState === xhr3.DONE) {
                  if (xhr3.status === 200) {
                    var mytext = xhr3.response;
                    var userid;
                    mytext = JSON.parse(mytext.substring(mytext.indexOf(`window._sharedData = `) + 21, mytext.indexOf(`;<\/script>`, mytext.indexOf(`window._sharedData = `) + 21)));
                    userid = mytext.entry_data.ProfilePage[0].graphql.user.id;
                    avatar = mytext.entry_data.ProfilePage[0].graphql.user.profile_pic_url_hd;
                    userid = (mytext.entry_data.ProfilePage[0].graphql.user.id);
                    avatar = mytext.entry_data.ProfilePage[0].graphql.user.profile_pic_url_hd;
                    $('#ans').html(`<div class="card text-white bg-dark mb-3" style="max-width: 18rem;"><div class="card-header"><img src="${avatar}" width="30px"> ${nickname}</div><div class="card-body"><p class="card-text"><a href="https://www.instagram.com/graphql/query/?query_hash=${hash}&amp;variables=%0A%7B%22reel_ids%22%3A%5B%22${userid}%22%5D%2C%22tag_names%22%3A%5B%5D%2C%22location_ids%22%3A%5B%5D%2C%22highlight_reel_ids%22%3A%5B%5D%2C%22precomposed_overlay%22%3Afalse%2C%22show_story_viewer_list%22%3Atrue%2C%22story_viewer_fetch_count%22%3A50%2C%22story_viewer_cursor%22%3A%22%22%2C%22stories_video_dash_manifest%22%3Afalse%7D" target="_blank">https://www.instagram.com/stories...</a></p></div></div><p class="lead">Перейдите по ссылке и скопируйте содержимое страницы. После вставьте его в поле ниже и нажмите "Обработать".</p></div><br><br><p class="lead"><p class="form-group col-md-12"><textarea id="code_rewive" placeholder="Код сюда" rows="3" class="form-control"></textarea></p><p class="col-md-12"><button type="button" id="Continue3" class="btn btn-success">Обработать</button></p></div>` );
                    console.log(userid);
                    console.log(hash);

                    $('#Continue3').on("click", function() {
                      var somecode = JSON.parse($('#code_rewive').val());
                      var cards ='';
                          somecode.data.reels_media[0].items.forEach(function(element) {
                            //Выдача переменных
                            var author_name = element.owner.username;
                            var long_create = Math.round((new Date() - element.taken_at_timestamp * 1000)/1000/3600);
                            if (element.is_video == true) {
                              var type_content = `<span class="badge badge-warning">Video</span>`
                            } else {
                              var type_content = `<span class="badge badge-info">Picture</span>`
                            }
                            var background_img = element.display_resources[2].src;
                            if (type_content == `<span class="badge badge-warning">Video</span>`) {
                              var download_link = element.video_resources[1].src
                            } else {
                              var download_link = background_img
                            }
                            //Присвоение пермеменных в карточках

                            console.log(cards);

                            cards = cards +
                              `<div class="card bg-dark text-white"><img src="${background_img}" class="card-img"><div class="card-img-overlay"><h5 class="card-title text-left">${author_name}${type_content}</h5><p class="card-text text-left" style="margin-top: 150%;">${long_create} ч.</p>                            <p class="card-text text-right"><a href="${download_link}" role="button" class="btn btn-success">Скачать</a></p></div></div>`;
                          });
                          console.log(cards);
                          $('#cards_ans').html(cards);
                    });

                  }
                }
              };

              xhr3.send();

            }
          });

        }
      }
    };

    xhr1.send();


  });
</script>

</html>
